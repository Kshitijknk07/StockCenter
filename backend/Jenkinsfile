pipeline {
    agent any
    
    tools {
        nodejs 'NodeJS 24'
    }
    
    stages {
        stage('Checkout') { 
            steps {
                checkout scm
            }
        }
        
        stage('Backend - Install Dependencies') {
            steps {
                dir('backend') {
                    sh 'npm install'
                }
            }
        }
        
        stage('Backend - Lint') {
            steps {
                dir('backend') {
                    sh 'npm run lint || true'
                }
            }
        }
        
        stage('Backend - Test') {
            steps {
                dir('backend') {
                    sh 'npm test || true'
                }
            }
        }
        
        stage('Frontend - Install Dependencies') {
            steps {
                dir('frotnend') {
                    sh 'npm install'
                }
            }
        }
        
        stage('Frontend - Lint') {
            steps {
                dir('frotnend') {
                    sh 'npm run lint || true'
                }
            }
        }
        
        stage('Frontend - Test') {
            steps {
                dir('frotnend') {
                    sh 'npm test || true'
                }
            }
        }
        
        stage('Frontend - Build') {
            steps {
                dir('frotnend') {
                    sh 'npm run build'
                }
            }
        }
        
        stage('Backend - Build Docker Image') {
            steps {
                dir('backend') {
                    sh 'docker build -t stockpilot-backend:${BUILD_NUMBER} .'
                }
            }
        }
        
        stage('Frontend - Build Docker Image') {
            steps {
                dir('frotnend') {
                    sh 'docker build -t stockpilot-frontend:${BUILD_NUMBER} .'
                }
            }
        }
        
        stage('Deploy Backend') {
            steps {
                dir('backend') {
                    sh '''
                    docker stop stockpilot-backend || true
                    docker rm stockpilot-backend || true
                    docker run -d --name stockpilot-backend \
                      -p 3000:3000 \
                      --env-file .env.docker \
                      --network stockpilot-network \
                      stockpilot-backend:${BUILD_NUMBER}
                    '''
                }
            }
        }
        
        stage('Deploy Frontend') {
            steps {
                dir('frotnend') {
                    sh '''
                    docker stop stockpilot-frontend || true
                    docker rm stockpilot-frontend || true
                    docker run -d --name stockpilot-frontend \
                      -p 80:80 \
                      --network stockpilot-network \
                      stockpilot-frontend:${BUILD_NUMBER}
                    '''
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
    }
}