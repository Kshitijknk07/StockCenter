pipeline {
    agent any
    
    tools {
        nodejs 'NodeJS 24'
    }
    
    environment {
        DOCKERHUB_CREDENTIALS = credentials('dockerhub') 
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_IMAGE_NAME = 'kshitijnk007/stockpilot-backend'
    }
    
    stages {
        stage('Checkout') { 
            steps {
                checkout scm
            }
        }
        
        stage('Backend - Install Dependencies') {
            steps {
                dir('backend') {
                    sh 'npm install'
                }
            }
        }
        
        stage('Backend - Lint') {
            steps {
                dir('backend') {
                    sh 'npm run lint || true'
                }
            }
        }
        
        stage('Backend - Test') {
            steps {
                dir('backend') {
                    sh 'npm test || true'
                }
            }
        }
        
        stage('Backend - Prepare Environment') {
            steps {
                dir('backend') {
                    sh '''
                    echo "Creating .env.docker file"
                    echo "NODE_ENV=production" > .env.docker
                    echo "PORT=3000" >> .env.docker
                    
                    echo "File contents:"
                    cat .env.docker
                    
                    echo "Current directory:"
                    pwd
                    
                    echo "Directory listing:"
                    ls -la
                    
                    echo "Creating Docker network"
                    docker network create stockpilot-network || true
                    '''
                }
            }
        }
        
        stage('Backend - Build Docker Image') {
            steps {
                dir('backend') {
                    sh '''
                    docker build -t stockpilot-backend:${BUILD_NUMBER} .
                    docker tag stockpilot-backend:${BUILD_NUMBER} ${DOCKER_IMAGE_NAME}:${BUILD_NUMBER}
                    docker tag stockpilot-backend:${BUILD_NUMBER} ${DOCKER_IMAGE_NAME}:latest
                    '''
                }
            }
        }
        
        stage('Backend - Push Docker Image') {
            steps {
                sh 'echo ${DOCKERHUB_CREDENTIALS_PSW} | docker login ${DOCKER_REGISTRY} -u ${DOCKERHUB_CREDENTIALS_USR} --password-stdin'
                
                sh '''
                docker push ${DOCKER_IMAGE_NAME}:${BUILD_NUMBER}
                docker push ${DOCKER_IMAGE_NAME}:latest
                '''
                
                sh 'docker logout ${DOCKER_REGISTRY}'
            }
        }
        
        stage('Deploy Backend') {
            steps {
                dir('backend') {
                    sh '''
                    docker stop stockpilot-backend || true
                    docker rm stockpilot-backend || true
                    docker run -d --name stockpilot-backend \
                      -p 3000:3000 \
                      -e NODE_ENV=production \
                      -e PORT=3000 \
                      --network stockpilot-network \
                      stockpilot-backend:${BUILD_NUMBER}
                    '''
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
    }
}